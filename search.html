<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ Bank API Genius AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --primary:#af232a; 
            --primary-light:#fe9b9b; 
            --accent:#fd79a8; 
            --dark:#1a1a2e; 
            --light:#ffffff; 
            --gray:#f1f3f6; 
            --text-dark:#2d3436; 
            --text-light:#636e72; 
            --shadow:0 15px 30px rgba(0,0,0,.12);
            --success:#af232a;
            --warning:#fd8f6e;
            --danger:#e17055;
            --info:#ff7474;
        }
        
        [data-theme="dark"] { 
            --primary:#e75c61; 
            --primary-light:#ee6b6b; 
            --dark:#121212; 
            --light:#2e1e1f; 
            --gray:#2d2d3a; 
            --text-dark:#f0f0f0; 
            --text-light:#b0b0b0; 
            --shadow:0 15px 30px rgba(0,0,0,.3); 
        }
        
        * { 
            margin:0; 
            padding:0; 
            box-sizing:border-box; 
            font-family:'Poppins',sans-serif; 
            transition: background .3s, color .3s, transform .3s; 
        }
        
        body { 
            background:linear-gradient(-45deg,#f5f7fa,#c3cfe2,#f5f7fa,#c3cfe2); 
            background-size:400% 400%; 
            animation:gradientBG 15s ease infinite; 
            min-height:100vh; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            padding:10px; 
            color:var(--text-dark); 
        }
        
        @keyframes gradientBG {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }
        
        [data-theme="dark"] body { 
            background:linear-gradient(-45deg,#290c0c,#632b2b,#3e2424,#290c0c); 
        }
        
        .chat-container { 
            width:100%; 
            max-width:1400px; 
            height:95vh; 
            background:var(--light); 
            border-radius:20px; 
            box-shadow:var(--shadow); 
            overflow:hidden; 
            display:flex; 
            flex-direction:column; 
            position:relative; 
        }
        
        .chat-header { 
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%); 
            color:#fff; 
            padding:22px; 
            display:flex; 
            align-items:center; 
            gap:18px; 
            z-index:10; 
            box-shadow:0 4px 12px rgba(0,0,0,.1); 
        }
        
        .logo { 
            width:50px; 
            height:50px; 
            background:#fff; 
            border-radius:50%; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            color:var(--primary); 
            font-size:22px; 
            font-weight:bold; 
            box-shadow:0 4px 8px rgba(0,0,0,.1); 
        }
        
        .header-text h2 { 
            font-weight:600; 
            margin:0; 
            font-size:1.6rem; 
            letter-spacing:.5px; 
        }
        
        .header-text p { 
            font-size:.9rem; 
            opacity:.9; 
            margin:0; 
        }
        
        .theme-toggle { 
            margin-left:auto; 
            background:rgba(255,255,255,.2); 
            border:none; 
            width:45px; 
            height:45px; 
            border-radius:50%; 
            color:#fff; 
            cursor:pointer; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            transition:all .3s; 
        }
        
        .theme-toggle:hover { 
            background:rgba(255,255,255,.3); 
            transform:rotate(30deg); 
        }
        
        .chat-body { 
            flex:1; 
            padding:25px; 
            overflow-y:auto; 
            background:var(--light); 
            scroll-behavior:smooth; 
            position:relative; 
        }
        
        .message { 
            margin-bottom:22px; 
            max-width:85%; 
            animation:fadeIn .4s cubic-bezier(.2,.6,.3,1); 
            position:relative; 
            opacity:0; 
            transform:translateY(10px); 
            animation-fill-mode:forwards; 
        }
        
        @keyframes fadeIn {
            to{opacity:1; transform:translateY(0)}
        }
        
        .user-message { 
            margin-left:auto; 
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%); 
            color:#fff; 
            border-radius:22px 22px 0 22px; 
            padding:16px 22px; 
            box-shadow:0 6px 16px rgba(231, 92, 92, 0.3); 
            min-width:120px; 
        }
        
        .bot-message { 
            margin-right:auto; 
            background:var(--gray); 
            border-radius:22px 22px 22px 0; 
            padding:18px; 
            box-shadow:0 4px 14px rgba(0,0,0,.08); 
            border-left:5px solid var(--primary); 
        }
        
        .message-time { 
            font-size:.75rem; 
            opacity:.7; 
            margin-top:8px; 
            text-align:right; 
            color:var(--text-light); 
        }
        
        .typing-indicator { 
            display:none; 
            margin-bottom:22px; 
            margin-right:auto; 
            background:var(--gray); 
            border-radius:22px 22px 22px 0; 
            padding:18px; 
            width:fit-content; 
            box-shadow:0 4px 8px rgba(0,0,0,.05); 
        }
        
        .typing-wave { 
            display:flex; 
            gap:8px; 
            align-items:flex-end; 
            height:20px; 
        }
        
        .typing-dot { 
            width:10px; 
            height:10px; 
            background:var(--primary); 
            border-radius:50%; 
            animation:waveAnimation 1.8s infinite ease-in-out; 
        }
        
        .typing-dot:nth-child(1){animation-delay:0s;height:6px}
        .typing-dot:nth-child(2){animation-delay:.2s;height:10px}
        .typing-dot:nth-child(3){animation-delay:.4s;height:14px}
        .typing-dot:nth-child(4){animation-delay:.6s;height:10px}
        .typing-dot:nth-child(5){animation-delay:.8s;height:6px}
        
        @keyframes waveAnimation {
           0%,60%,100%{transform:translateY(0);opacity:.6}
           30%{transform:translateY(-8px);opacity:1}
        }
        
        .input-area { 
            padding:20px; 
            background:var(--light); 
            border-top:1px solid rgba(0,0,0,.05); 
            display:flex; 
            gap:15px; 
            position:relative; 
            z-index:5; 
        }
        
        #user-input { 
            flex:1; 
            border-radius:50px; 
            padding:16px 24px; 
            border:none; 
            outline:none; 
            font-size:1rem; 
            background:var(--gray); 
            color:var(--text-dark); 
            box-shadow:0 4px 12px rgba(0,0,0,.05); 
            transition:all .3s; 
        }
        
        #user-input:focus { 
            box-shadow:0 0 0 3px rgba(231, 92, 92, 0.3); 
            transform:translateY(-2px); 
        }
        
        #send-btn { 
            width:60px; 
            height:60px; 
            border-radius:50%; 
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%); 
            color:#fff; 
            border:none; 
            cursor:pointer; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            transition:all .3s cubic-bezier(.2,.8,.3,1.2); 
            box-shadow:0 6px 18px rgba(231, 92, 92, 0.4); 
            position:absolute; 
            right:20px; 
            bottom:20px; 
        }
        
        #send-btn:hover { 
            transform:translateY(-5px) scale(1.05); 
            box-shadow:0 10px 25px rgba(231, 92, 92, 0.5); 
        }
        
        #send-btn:active { 
            transform:translateY(0) scale(.98); 
        }
        
        .api-section { 
            margin:20px 0; 
            padding:18px; 
            background:var(--light); 
            border-radius:14px; 
            border-left:5px solid var(--primary); 
            box-shadow:0 4px 14px rgba(0,0,0,.08); 
            transition:all .4s cubic-bezier(.2,.6,.3,1); 
        }
        
        .api-section:hover { 
            transform:translateY(-5px); 
            box-shadow:0 8px 20px rgba(0,0,0,.12); 
        }
        
        .api-section h5 { 
            color:var(--primary); 
            margin-bottom:14px; 
            font-weight:600; 
            display:flex; 
            align-items:center; 
            gap:12px; 
            font-size:1.1rem; 
        }
        
        .api-section h5 i { 
            font-size:1.2rem; 
        }
        
        pre { 
            background:var(--dark); 
            color:#fff; 
            padding:16px; 
            border-radius:10px; 
            overflow-x:auto; 
            font-family:'Courier New',monospace; 
            font-size:.95rem; 
            margin:14px 0; 
            box-shadow:inset 0 0 10px rgba(0,0,0,.2); 
        }
        
        code { 
            background:rgba(108,92,231,.15); 
            padding:4px 8px; 
            border-radius:5px; 
            font-family:'Courier New',monospace; 
            font-size:.9rem; 
            color:var(--primary); 
        }
        
        .suggestion-chips { 
            display:flex; 
            flex-wrap:wrap; 
            gap:14px; 
            margin:20px 0; 
        }
        
        .suggestion-chip { 
            background:rgba(108,92,231,.1); 
            color:var(--primary); 
            padding:12px 20px; 
            border-radius:50px; 
            font-size:.9rem; 
            cursor:pointer; 
            transition:all .3s ease; 
            border:none; 
            box-shadow:0 2px 8px rgba(0,0,0,.05); 
        }
        
        .suggestion-chip:hover { 
            background:rgba(231, 92, 108, 0.2); 
            transform:translateY(-3px); 
            box-shadow:0 4px 12px rgba(0,0,0,.1); 
        }
        
        ::-webkit-scrollbar { width:10px; } 
        ::-webkit-scrollbar-track { background:var(--gray); border-radius:5px; } 
        ::-webkit-scrollbar-thumb { background:var(--primary-light); border-radius:5px; } 
        ::-webkit-scrollbar-thumb:hover { background:var(--primary); }
        
        /* Enhanced API Gallery styles */
        .api-gallery { 
            display:grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap:20px; 
            margin-top:20px;
        }
        
        .api-card { 
            background:var(--light); 
            border-radius:20px; 
            padding:24px; 
            box-shadow:0 10px 30px rgba(0,0,0,.08); 
            border:1px solid rgba(0,0,0,.06); 
            position:relative; 
            overflow:hidden; 
            transition:all .4s cubic-bezier(.2,.6,.3,1);
            backdrop-filter: blur(10px);
        }
        
        .api-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--info));
            opacity: 0;
            transition: opacity .3s ease;
        }
        
        .api-card:hover::before {
            opacity: 1;
        }
        
        .api-card:hover { 
            transform:translateY(-8px) scale(1.02); 
            box-shadow:0 20px 40px rgba(0,0,0,.15); 
        }
        
        .api-card .badge { 
            position:absolute; 
            top:20px; 
            right:20px; 
            background: linear-gradient(135deg, var(--success), var(--info));
            color: white;
            border: none;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
        }
        
        .api-card .icon { 
            width:60px; 
            height:60px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            border-radius:16px; 
            background:linear-gradient(135deg, var(--primary-light), var(--primary)); 
            color:#fff; 
            box-shadow:0 8px 24px rgba(231, 92, 99, 0.35); 
            margin-bottom: 16px;
            transition: all .3s ease;
        }
        
        .api-card:hover .icon {
            transform: rotate(5deg) scale(1.1);
            box-shadow:0 12px 32px rgba(231, 94, 92, 0.5);
        }
        
        .api-card h5 { 
            margin:0 0 8px; 
            font-weight:600; 
            font-size: 1.25rem;
            color: var(--text-dark);
        }
        
        .api-card p { 
            color:var(--text-light); 
            font-size:.95rem; 
            line-height: 1.5;
            margin-bottom: 20px;
        }
        
        .api-card .btn { 
            border-radius:12px; 
            font-weight: 500;
            padding: 10px 20px;
            transition: all .3s ease;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .api-card .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left .5s ease;
        }
        
        .api-card .btn:hover::before {
            left: 100%;
        }
        
        .api-card .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231, 97, 92, 0.4);
        }
        
        /* Enhanced Details Section */
        .api-details {
            margin-top: 20px;
            background: linear-gradient(135deg, var(--gray), rgba(108,92,231,.05));
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            border: 1px solid rgba(108,92,231,.1);
        }
        
        .details-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 16px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .details-content {
            padding: 24px;
        }
        
        .detail-section {
            margin-bottom: 24px;
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,.05);
            transition: all .3s ease;
        }
        
        .detail-section:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0,0,0,.1);
        }
        
        .detail-section h6 {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-section .section-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        
        .code-block {
            background: var(--dark);
            color: #fff;
            padding: 20px;
            border-radius: 12px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 12px 0;
            box-shadow: inset 0 0 20px rgba(0,0,0,.3);
            border: 1px solid rgba(255,255,255,.1);
            position: relative;
        }
        
        .code-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--info));
        }
        
        .endpoint-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--success), var(--info));
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin: 4px 0;
        }
        
        .auth-info {
            background: linear-gradient(135deg, rgba(253, 121, 130, 0.1), rgba(255, 130, 116, 0.1));
            border: 1px solid rgba(253, 121, 121, 0.2);
            border-radius: 10px;
            padding: 16px;
            margin: 12px 0;
        }
        
        .spinner-sm { 
            width:1.2rem; 
            height:1.2rem; 
            border:.18em solid rgba(0,0,0,.15); 
            border-top-color: var(--primary); 
            border-radius:50%; 
            animation:spin .8s linear infinite; 
            display:inline-block; 
        }
        
        @keyframes spin { 
            to{ transform:rotate(360deg); } 
        }
        
        .gallery-actions { 
            display:flex; 
            gap:12px; 
            margin-bottom:20px; 
            flex-wrap: wrap;
        }
        
        .gallery-actions .btn {
            border-radius: 25px;
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all .3s ease;
        }
        
        .gallery-actions .btn:hover {
            transform: translateY(-2px);
        }
        
        /* Search Results Header */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(108,92,231,.1), rgba(162,155,254,.1));
            border-radius: 16px;
            border-left: 4px solid var(--primary);
        }
        
        .results-count {
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .relevance-score {
            background: linear-gradient(135deg, var(--success), var(--info));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Button group for API actions */
        .api-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .api-actions .btn {
            flex: 1;
        }
        
        .download-btn {
            background: linear-gradient(135deg, var(--success), var(--info)) !important;
        }
        
        /* Full Screen API Modal */
        .api-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }
        
        .api-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .api-modal-content {
            background: var(--light);
            border-radius: 20px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .api-modal.active .api-modal-content {
            transform: scale(1);
        }
        
        .api-modal-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .api-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .api-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .api-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .api-modal-body {
            padding: 30px;
        }
        
        /* Responsive Design Enhancements */
        @media (max-width: 1200px) {
            .api-gallery { 
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
                gap: 16px;
            }
            .chat-container {
                max-width: 95%;
                height: 90vh;
            }
        }
        
        @media (max-width: 768px) { 
            .chat-header { 
                padding:16px;
                flex-wrap: wrap;
            } 
            .logo { 
                width:40px; 
            height:40px; 
                font-size:18px;
            } 
            .header-text h2 { 
                font-size:1.2rem;
            }
            .header-text p {
                font-size: 0.8rem;
            }
            #send-btn { 
                width:50px; 
                height:50px;
            }
            .api-gallery { 
                grid-template-columns: 1fr; 
                gap: 16px;
            }
            .api-card {
                padding: 20px;
            }
            .chat-body {
                padding: 16px;
            }
            .message {
                max-width: 95%;
            }
            .suggestion-chips {
                gap: 8px;
            }
            .suggestion-chip {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
            .gallery-actions {
                justify-content: center;
            }
            .input-area {
                padding: 16px;
            }
            #user-input {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            .api-actions {
                flex-direction: column;
            }
            .api-modal-content {
                max-height: 95vh;
            }
            .api-modal-header {
                padding: 15px 20px;
            }
            .api-modal-body {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) { 
            .chat-container {
                border-radius: 15px;
                height: 95vh;
            }
            .api-card { 
                padding: 16px;
            }
            .api-card .icon {
                width: 50px;
                height: 50px;
            }
            .api-card h5 {
                font-size: 1.1rem;
            }
            .detail-section {
                padding: 16px;
            }
            .details-content {
                padding: 16px;
            }
            .code-block {
                padding: 16px;
                font-size: 0.8rem;
            }
            body {
                padding: 5px;
            }
            .api-modal {
                padding: 10px;
            }
            .api-modal-title {
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 360px) {
            .header-text h2 {
                font-size: 1rem;
            }
            .header-text p {
                display: none;
            }
            .api-gallery {
                gap: 12px;
            }
        }
        
        /* Loading Animation Enhancement */
        .loading-shimmer {
            background: linear-gradient(90deg, var(--gray) 25%, rgba(108,92,231,.1) 50%, var(--gray) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
           0% { background-position: -200% 0; }
           100% { background-position: 200% 0; }
        }
        
        /* PDF download button styles */
        .download-progress {
            display: none;
            margin-top: 10px;
            text-align: center;
            color: var(--primary);
        }
        
        .download-progress .spinner-sm {
            margin-right: 8px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <div class="logo">
            <img src="static/8c80ec1c0cf7e81330cd4da9bcf27cab.jpg" alt="Logo" class="logo-img">
        </div>

        <div class="header-text">
            <h2>ICICI Bank API Genius AI</h2>
            <p>Your intelligent banking API companion</p>
        </div>
        <button class="theme-toggle" id="theme-toggle"><i class="fas fa-moon"></i></button>
    </div>

    <div class="chat-body" id="chat-body">
        <div class="message bot-message" style="opacity:1; transform:translateY(0)">
            <div class="welcome-message">
                <h4><i class="fas fa-robot"></i> Welcome to Bank API Search AI !</h4>
                <p>I can help you discover, understand, and implement banking APIs. Try asking:</p>
                <div class="suggestion-chips">
                    <button class="suggestion-chip" onclick="insertSuggestion(this)">Show payment APIs</button>
                    <button class="suggestion-chip" onclick="insertSuggestion(this)">How to authenticate requests?</button>
                    <button class="suggestion-chip" onclick="insertSuggestion(this)">Account balance API details</button>
                    <button class="suggestion-chip" onclick="insertSuggestion(this)">Transaction history endpoints</button>
                </div>
            </div>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-wave">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Ask about bank APIs..." autocomplete="off">
        <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<!-- Full Screen API Modal -->
<div class="api-modal" id="api-modal">
    <div class="api-modal-content">
        <div class="api-modal-header">
            <div class="api-modal-title">
                <i class="fas fa-code"></i>
                <span id="modal-api-name">API Details</span>
            </div>
            <button class="api-modal-close" id="api-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="api-modal-body" id="api-modal-body">
            <!-- API details will be inserted here -->
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Initialize jsPDF
const { jsPDF } = window.jspdf;

$(document).ready(function(){
  const savedTheme = localStorage.getItem('theme') || 'light';
  setTheme(savedTheme);
  $('#theme-toggle').click(function(){ 
    const current=$('body').attr('data-theme')||'light'; 
    const next=current==='light'?'dark':'light'; 
    setTheme(next); 
    localStorage.setItem('theme',next); 
  });
  
  function setTheme(t){ 
    $('body').attr('data-theme',t); 
    $('#theme-toggle').html(`<i class="fas ${t==='dark'?'fa-sun':'fa-moon'}"></i>`); 
  }
  
  scrollToBottom();
  $('#send-btn').click(sendMessage);
  $('#user-input').keypress(function(e){ if(e.which==13){ sendMessage(); }});
  
  // Close modal when clicking on close button
  $('#api-modal-close').click(function() {
      $('#api-modal').removeClass('active');
  });
  
  // Close modal when clicking outside content
  $('#api-modal').click(function(e) {
      if (e.target === this) {
          $('#api-modal').removeClass('active');
      }
  });
  
  // Close modal with Escape key
  $(document).keyup(function(e) {
      if (e.key === "Escape" && $('#api-modal').hasClass('active')) {
          $('#api-modal').removeClass('active');
      }
  });

  function sendMessage(){
    const userInput=$('#user-input').val().trim(); 
    if(userInput==='') return;
    addMessage(userInput,'user'); 
    $('#user-input').val('');

    // Show typing indicator
    showTypingIndicator();
    
    // Send request to backend API
    $.ajax({
      type: 'POST',
      url: '/ask',
      data: { query: userInput },
      success: function(response) {
        hideTypingIndicator();
        if (response.response && response.response.includes("API Name:")) {
            console.log('response.response',response.response)
          // Parse API response and display in cards
          const apiCards = parseApiResponse(response.response);
          addMessage(renderApiGallery(apiCards, userInput), 'bot');
        } else {
          // Regular text response
          addMessage(response.response, 'bot');
        }
      },
      error: function(xhr) {
        hideTypingIndicator();
        let errorMsg = "Sorry, I encountered an error processing your request.";
        if (xhr.responseJSON?.error) {
          errorMsg += `<br><small>${xhr.responseJSON.error}</small>`;
        }
        addMessage(errorMsg, 'bot');
      }
    });
  }

  function parseApiResponse(responseText) {
    const apiSections = responseText.split(/(?=API Name:)/g);
    const apiCards = [];
    console.log('apiCards',apiCards)
    
    apiSections.forEach(section => {
      if (!section.trim()) return;
      
      // Extract API information using regex - UPDATED FOR YOUR BACKEND FORMAT
      const apiNameMatch = section.match(/API Name:\s*(.*?)(?=\n|$)/i);
      const purposeMatch = section.match(/Purpose:\s*(.*?)(?=\n|$)/i);
      console.log('purposeMatch',purposeMatch)
        
      const urlMatch = section.match(/URL:\s*([\s\S]*?)(?=\n\s*\n|\n\d+\.|$)/i);
      const urlBlock = urlMatch ? urlMatch[1] : '';
      const urls = urlBlock.match(/https?:\/\/[^\s`*]+/g) || [];
      console.log('urlMatch',urlMatch)
      const requestAttrsMatch = section.match(/Required Request Attributes:\s*([\s\S]*?)(?=Request Body:|Response Body:|Implementation Steps:|$)/i);
      const requestBodyMatch = section.match(/Request Body.*?:\s*([\s\S]*?)(?=Response Body:|Implementation Steps:|$)/i);
      const responseBodyMatch = section.match(/Response Body.*?:\s*([\s\S]*?)(?=Implementation Steps:|$)/i);
      const implementationMatch = section.match(/Implementation Steps:\s*([\s\S]*?)(?=$)/i);
      const attributesRelationMatch = section.match(/How the matched attributes relate to the user query:\s*([\s\S]*?)(?=Implementation Steps:|$)/i);
      
      if (apiNameMatch) {
        apiCards.push({
          name: apiNameMatch[1].trim(),
          purpose: purposeMatch ? purposeMatch[1].trim() : 'No purpose provided',
          url: urls.length ? urls.join('<br>') : 'No URL found',
          endpoint: '', // Your backend doesn't seem to provide this directly
          request: requestBodyMatch ? requestBodyMatch[1].trim() : '',
          response: responseBodyMatch ? responseBodyMatch[1].trim() : '',
          requestAttributes: requestAttrsMatch ? requestAttrsMatch[1].trim() : '',
          implementation: implementationMatch ? implementationMatch[1].trim() : '',
          attributesRelation: attributesRelationMatch ? attributesRelationMatch[1].trim() : '',
          relevance: 0.95, // Default high relevance since backend already ranked them
          icon: getApiIcon(apiNameMatch[1].trim())
        });
      }
      
    });
    
    return apiCards;
  }

  function getApiIcon(apiName) {
    // Map API names to appropriate icons
    const iconMap = {
      'payment': 'fa-money-check',
      'transfer': 'fa-exchange-alt',
      'balance': 'fa-scale-balanced',
      'transaction': 'fa-receipt',
      'account': 'fa-user',
      'auth': 'fa-key',
      'customer': 'fa-users',
      'card': 'fa-credit-card',
      'loan': 'fa-hand-holding-usd',
      'investment': 'fa-chart-line',
      'payout': 'fa-money-bill-transfer',
      'upi': 'fa-mobile-alt',
      'imps': 'fa-bolt',
      'neft': 'fa-building-columns',
      'rtgs': 'fa-arrows-rotate',
      'refund': 'fa-rotate-left'
    };
    
    apiName = apiName.toLowerCase();
    for (const [key, icon] of Object.entries(iconMap)) {
      if (apiName.includes(key)) {
        return icon;
      }
    }
    
    return 'fa-code'; // Default icon
  }

  function renderApiGallery(apiCards, query) {
    if (apiCards.length === 0) {
      return `<div class="message-content">No API results found for your query. Try a different search term.</div>`;
    }
    
    let grid = `
    <div>
      <div class="results-header">
        <div class="results-count">
          <i class="fa-solid fa-magnifying-glass"></i>
          Found ${apiCards.length} API${apiCards.length !== 1 ? 's' : ''} for "${query}"
        </div>
        <div class="relevance-score">${apiCards.length} results</div>
      </div>
      <div class="gallery-actions">
        <button class="btn btn-sm btn-outline-primary" id="expand-all">
          <i class="fa-solid fa-chevron-down me-1"></i>Show All Details
        </button>
        <button class="btn btn-sm btn-outline-secondary" id="collapse-all">
          <i class="fa-solid fa-chevron-up me-1"></i>Hide All Details
        </button>
      </div>
      <div class="api-gallery">`;
      
    apiCards.forEach((api, index) => {
      const id = `api-${index}-${Date.now()}`;
      grid += `
        <div class="api-card">
          <span class="badge">${(api.relevance * 100).toFixed(0)}% Match</span>
          <div class="icon"><i class="fa-solid ${api.icon}"></i></div>
          <h5>${api.name}</h5>
          <p>${api.purpose}</p>
          <div class="api-actions">
            
            <button class="btn view-fullscreen-btn" data-api-index="${index}">
              <i class="fa-solid fa-expand me-2"></i>View Details
            </button>
            <button class="btn download-btn download-api-btn" data-api-index="${index}">
              <i class="fa-solid fa-download me-2"></i>Save as PDF
            </button>
          </div>
          <div class="download-progress" id="download-progress-${index}">
            <span class="spinner-sm"></span> Generating PDF...
          </div>
          <div id="${id}" class="collapse api-details">
            <div class="details-header">
              <i class="fa-solid fa-code"></i>
              <span>API Documentation</span>
            </div>
            <div class="details-content">
              ${renderApiDetails(api)}
            </div>
          </div>
        </div>`;
    });
    grid += `</div></div>`;
    return grid;
  }

  function renderApiDetails(api) {
    return `
      <div class="detail-section">
        <h6><span class="section-icon"><i class="fa-solid fa-bullseye"></i></span>Purpose</h6>
        <p>${api.purpose}</p>
      </div>
      
      ${api.url ? `
      <div class="detail-section">
        <h6><span class="section-icon"><i class="fa-solid fa-link"></i></span>URL</h6>
        <div class="code-block">${api.url}</div>
      </div>
      ` : ''}
      
      ${api.requestAttributes ? `
      <div class="detail-section">
        <h6><span class="section-icon"><i class="fa-solid fa-list-check"></i></span>Required Request Attributes</h6>
        <div class="detail-content">${formatAttributes(api.requestAttributes)}</div>
      </div>
      ` : ''}
      
      ${api.request ? `
      <div class="detail-section">
        <h6><span class="section-icon"><i class="fa-solid fa-upload"></i></span>Request Body</h6>
        <div class="code-block">${formatJsonIfPossible(api.request)}</div>
      </div>             
      ` : ''}
      
      ${api.response ? `
      <div class="detail-section">
        <h6><span class="section-icon"><i class="fa-solid fa-download"></i></span>Response Body</h6>
        <div class="code-block">${formatJsonIfPossible(api.response)}</div>
      </div>
      ` : ''}
      
      
      
      ${api.implementation ? `
      <div class="detail-section">
        <h6><span class="section-icon"><i class="fa-solid fa-list-check"></i></span>Implementation Steps</h6>
        <div class="detail-content">${formatSteps(api.implementation)}</div>
      </div>
      ` : ''}
      
      <div class="detail-section">
        <h6><span class="section-icon"><i class="fa-solid fa-gears"></i></span>General Implementation Guide</h6>
        <ol style="margin-left: 20px; line-height: 1.6;">
          <li>Review the API documentation above</li>
          <li>Set up authentication as required</li>
          <li>Prepare the request payload with required attributes</li>
          <li>Make the API call to the endpoint</li>
          <li>Handle the response and errors appropriately</li>
          <li>Implement retry logic for failed requests</li>
          <li>Test thoroughly in sandbox environment before production</li>
        </ol>
      </div>`;
  }

  function formatAttributes(text) {
    if (!text) return '<p>No attributes specified</p>';
    
    // Try to parse as list items
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length > 0) {
      let html = '<ul style="margin-left: 20px;">';
      lines.forEach(line => {
        if (line.trim()) {
          html += `<li>${line.trim()}</li>`;
        }
      });
      html += '</ul>';
      return html;
    }
    
    return `<p>${text}</p>`;
  }

  function formatSteps(text) {
    if (!text) return '<p>No implementation steps provided</p>';
    
    // Try to parse as numbered steps
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length > 0) {
      let html = '<ol style="margin-left: 20px; line-height: 1.6;">';
      lines.forEach(line => {
        if (line.trim()) {
          // Remove leading numbers if present
          const cleanLine = line.replace(/^\d+\.\s*/, '').trim();
          html += `<li>${cleanLine}</li>`;
        }
      });
      html += '</ol>';
      return html;
    }
    
    return `<p>${text}</p>`;
  }

  function formatJsonIfPossible(text) {
    if (!text) return 'No data provided';
    
    // Try to parse as JSON
    try {
      const jsonObj = JSON.parse(text);
      return JSON.stringify(jsonObj, null, 2);
    } catch (e) {
      // Not valid JSON, return as is with code formatting
      return text;
    }
  }

  // Enhanced click handler for API cards
  $('#chat-body').on('click','.view-api-btn',function(){
    const apiName=$(this).data('api-name');
    const target=$(this).data('target');
    const $collapse=$(target);
    const $btn = $(this);
    
    $collapse.collapse('toggle');

    // Update button text based on collapse state
    $collapse.on('shown.bs.collapse', function() {
      $btn.html('<i class="fa-solid fa-eye-slash me-2"></i>Hide Details');
    });
    
    $collapse.on('hidden.bs.collapse', function() {
      $btn.html('<i class="fa-solid fa-eye me-2"></i>View Details');
    });
  });
  
  // Full screen view handler
  $('#chat-body').on('click','.view-fullscreen-btn',function(){
    const apiIndex = $(this).data('api-index');
    const $apiCard = $(this).closest('.api-card');
    const apiName = $apiCard.find('h5').text();
    const apiPurpose = $apiCard.find('p').text();
    const apiDetails = $apiCard.find('.api-details').html();
    
    // Show full screen modal
    showApiFullScreen(apiName, apiPurpose, apiDetails);
  });

  function showApiFullScreen(name, purpose, details) {
    // Set modal title
    $('#modal-api-name').text(name);
    
    // Build modal content
    const modalContent = `
      <div class="detail-section">
        <h6><span class="section-icon"><i class="fa-solid fa-bullseye"></i></span>Purpose</h6>
        <p>${purpose}</p>
      </div>
      ${details ? details : '<p>No additional details available.</p>'}
    `;
    
    // Insert content into modal
    $('#api-modal-body').html(modalContent);
    
    // Show modal
    $('#api-modal').addClass('active');
    
    // Prevent body scrolling when modal is open
    $('body').css('overflow', 'hidden');
  }

  // Handle modal close
  $('#api-modal-close, #api-modal').on('click', function(e) {
    if (e.target === this || $(e.target).is('#api-modal-close')) {
      $('#api-modal').removeClass('active');
      $('body').css('overflow', 'auto');
    }
  });

  // Enhanced expand/collapse all functionality
  $('#chat-body').on('click','#expand-all',function(){ 
    const $gallery = $(this).closest('.message');
    $gallery.find('.api-card .collapse').each(function() {
      const $collapse = $(this);
      if(!$collapse.hasClass('show')) {
        $collapse.collapse('show');
        $collapse.prev().find('.view-api-btn').html('<i class="fa-solid fa-eye-slash me-2"></i>Hide Details');
      }
    });
  });
  
  $('#chat-body').on('click','#collapse-all',function(){ 
    const $gallery = $(this).closest('.message');
    $gallery.find('.api-card .collapse.show').each(function() {
      $(this).collapse('hide');
      $(this).prev().find('.view-api-btn').html('<i class="fa-solid fa-eye me-2"></i>View Details');
    });
  });

  // Download API as PDF functionality
  $('#chat-body').on('click', '.download-api-btn', function() {
    const apiIndex = $(this).data('api-index');
    const $apiCard = $(this).closest('.api-card');
    const apiName = $apiCard.find('h5').text();
    const $progress = $(`#download-progress-${apiIndex}`);
    
    // Show progress indicator
    $progress.show();
    
    // Generate PDF after a short delay to allow UI to update
    setTimeout(() => {
      generateApiPdf($apiCard, apiName, apiIndex);
    }, 100);
  });

  function generateApiPdf($apiCard, apiName, apiIndex) {
    // Create a temporary div to hold the content for PDF generation
    const $tempDiv = $('<div>').css({
      width: '800px',
      padding: '20px',
      backgroundColor: 'white',
      color: 'black'
    });
    
    // Add API name as title
    $tempDiv.append(`<h1 style="color: #6c5ce7; border-bottom: 2px solid #6c5ce7; padding-bottom: 10px; margin-bottom: 20px;">${apiName}</h1>`);
    
    // Add purpose
    const purpose = $apiCard.find('p').text();
    $tempDiv.append(`<h2 style="color: #6c5ce7; margin-top: 20px;">Purpose</h2><p>${purpose}</p>`);
    
    // Add details if expanded
    const $apiDetails = $apiCard.find('.api-details');
    if ($apiDetails.hasClass('show')) {
      $apiDetails.find('.detail-section').each(function() {
        const title = $(this).find('h6').text();
        let content = '';
        
        // Handle different content types
        if ($(this).find('.code-block').length) {
          content = `<pre style="background: #2d2d2d; color: white; padding: 15px; border-radius: 5px; overflow-x: auto;">${$(this).find('.code-block').text()}</pre>`;
        } else if ($(this).find('ol, ul').length) {
          content = $(this).find('ol, ul').prop('outerHTML');
        } else {
          content = $(this).find('.detail-content').html() || $(this).find('p').html();
        }
        
        $tempDiv.append(`<h2 style="color: #6c5ce7; margin-top: 20px;">${title}</h2>${content}`);
      });
    } else {
      $tempDiv.append('<p style="color: #666; font-style: italic;">Expand details in the app to see full documentation in PDF.</p>');
    }
    
    // Add footer with timestamp
    const timestamp = new Date().toLocaleString();
    $tempDiv.append(`<div style="margin-top: 40px; padding-top: 10px; border-top: 1px solid #ccc; color: #666; font-size: 12px;">Generated by Bank API Genius AI on ${timestamp}</div>`);
    
    // Add to DOM temporarily
    $('body').append($tempDiv);
    
    // Use html2canvas and jsPDF to generate PDF
    html2canvas($tempDiv[0], {
      scale: 2,
      useCORS: true,
      logging: false
    }).then(canvas => {
      // Remove temporary div
      $tempDiv.remove();
      
      // Create PDF
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const imgWidth = 210; // A4 width in mm
      const pageHeight = 295; // A4 height in mm
      const imgHeight = canvas.height * imgWidth / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;
      
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
      
      // Add additional pages if needed
      while (heightLeft >= 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }
      
      // Save the PDF
      pdf.save(`API Documentation - ${apiName}.pdf`);
      
      // Hide progress indicator
      $(`#download-progress-${apiIndex}`).hide();
    }).catch(error => {
      console.error('Error generating PDF:', error);
      $(`#download-progress-${apiIndex}`).hide();
      alert('Error generating PDF. Please try again.');
    });
  }

  function addMessage(message, sender, timestamp) {
    const time = timestamp || new Date().toLocaleTimeString();
    const messageClass = sender === 'user' ? 'user-message' : 'bot-message';
    const messageHtml = `
      <div class="message ${messageClass}">
        ${message}
        <div class="message-time">${time}</div>
      </div>`;
    $('#chat-body').append(messageHtml);
    scrollToBottom();
  }

  function showTypingIndicator() {
    $('#typing-indicator').show();
    scrollToBottom();
  }

  function hideTypingIndicator() {
    $('#typing-indicator').hide();
  }

  function scrollToBottom() {
    $('#chat-body').scrollTop($('#chat-body')[0].scrollHeight);
  }

  window.insertSuggestion = function(element) {
    $('#user-input').val($(element).text());
    $('#user-input').focus();
  }

  // Add some demo functionality for other suggestion chips
  $('.suggestion-chip').click(function() {
    const text = $(this).text();
    $('#user-input').val(text);
    setTimeout(() => {
      sendMessage();
    }, 100);
  });
});
</script>
</body>
</html>